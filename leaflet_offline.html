<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>オフラインマップ</title>
    <link rel="stylesheet" href="./css/leaflet.css" />
    <script src="./js/leaflet.js"></script>
    <link rel='stylesheet' href='./css/easy-button.css'/>
    <script src='./js/easy-button.js'></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /*現在地の点*/
        .location {
            width: 20px !important;
            height: 20px !important;
            border-radius: 10px;
            border: 3px solid #fdfdfd;
            box-shadow: 1px 1px 4px rgb(255, 68, 205);
            background-color: rgb(255, 68, 205);
        }

        /*ズームボタン*/
        .leaflet-control-zoom a{
            width: 120px !important;
            height: 120px !important;
            line-height: 120px !important;
            font-size: 60px !important;
        }

        /*終了ボタン*/
        .leaflet-bar button {
            height: 100px !important;
            width: 100px !important;
            line-height: 100px !important;
            font-size: 30pt;
        }
    </style>
    <script>
        // ウェブサーバをポート番号10000で接続する。
        var webSocket = new WebSocket("ws://localhost:10000");

        function init() {
            //地図を表示するdiv要素のidを設定
            var map = L.map('mapcontainer', { zoomControl: false });

            //初期位置の座標の指定（神戸高専の中庭）
            var lat = 34.679;
            var lon = 135.0670;
            var mpoint = [lat, lon];

            //中心位置(mpoint)とズームレベルの設定
            map.setView(mpoint, 17);

            //"file:///ズームレベルごとの地図ファイルがあるディレクトリのパス/{z}/{x}/{y}.png"
            L.tileLayer('file:////home/pi/map/offline_map/QGIS/{z}/{x}/{y}.png', {
                minZoom: 14,    //最小ズームレベル
                maxZoom: 19,    //最大ズームレベル
                tms: false,
                attribution: 'Generated by TilesXYZ'
            }).addTo(map);

            //スケールバー(縮尺)を最大幅300px、右下、m単位で地図に追加
            L.control.scale({ maxWidth: 300, position: 'bottomright', imperial: false }).addTo(map);
            //ズームコントロールを左下で地図に追加
            L.control.zoom({ position: 'bottomleft' }).addTo(map);

            //現在地の点の設定
            var location = L.divIcon({ className: 'location', iconAnchor: [13, 13] });
            var location_set = L.marker(mpoint, { icon: location }).addTo(map);

            //終了ボタンを右上に追加
            L.easyButton('<strong>終了</strong>', function(btn, easyMap){
                window.close();
            },{position:'topright'}).addTo(map);

            setInterval(
                function () {
                    // ソケットサーバからメッセージが受信すれば呼び出す関数。
                    webSocket.onmessage = function(message){
                        var array_message = message.data.split(', ');
                        lat = parseFloat(array_message[0]);
                        lon = parseFloat(array_message[1]);
                        mpoint = [lat, lon];
                    };

                    //現在地の点の再配置
                    map.removeLayer(location_set)
                    location_set = L.marker(mpoint, { icon: location }).addTo(map);
                    map.setView(mpoint);
                }, 300 //0.3秒(300[ms])おきに更新
            )
        }
    </script>
</head>
<body onload="init()">
    <div id="mapcontainer" style="position:absolute; top:0;left:0;right:0;bottom:0;"></div>
</body>
</html>